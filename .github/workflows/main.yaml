# This is a basic workflow to help you get started with Actions

name: Sample workflow to build an image

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events 
  push:
    branches: [
        master,
        feature/release-python3
      ]
  pull_request:
    branches: [
        master,
        feature/release-python3
    ]
jobs:
  sast_scan:
    runs-on: ubuntu-latest
    env: 
      SONAR_URL: "https://sonar.prod.amdtx.wildflowers-na.com"
      
    steps: 
      - name: code base clone
        uses: actions/checkout@v3.0.0

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@2.3.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_URL }}

  build_and_push_artifact:
    # equal with agent build
    #${{github.head_ref || github.ref_name}}-
    runs-on: ubuntu-latest 
    env:
      ACR_REPO_NAME: quyencl91/vti-test
      ACR_SERVER: docker.io
      TAG_NAME: ${{ github.sha }}
    steps:
      - name: code base clone
        uses: actions/checkout@v3.0.0
        # with:
        #   ref: 'main'
      - name: Build a sample Docker image with Firefox
        run: |
          docker build -t ${{ env.ACR_REPO_NAME }}:${{ env.TAG_NAME }} --file appbuild.dockerfile .

      - name: login to docker registry 
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Push the docker image to ${{ env.ACR_REPO_NAME }}
        run: |
          docker push ${{ env.ACR_REPO_NAME }}:${{ env.TAG_NAME }}
